# 阿里云容器镜像服务配置教程

## 📋 目录
1. [问题说明](#问题说明)
2. [解决方案](#解决方案)
3. [阿里云容器镜像服务配置](#阿里云容器镜像服务配置)
4. [GitHub Secrets 配置](#github-secrets-配置)
5. [验证部署](#验证部署)
6. [使用镜像](#使用镜像)

---

## 问题说明

GitHub Actions 在构建 Docker 镜像时出现 503 错误，主要原因：
- 🌐 GitHub Actions 服务器访问某些资源可能受限
- 📦 npm 包下载速度慢或连接超时
- 🐋 Docker Hub 拉取基础镜像速度慢

## 解决方案

### ✅ 已实施的优化

1. **Dockerfile 优化**
   - 使用阿里云 npm 镜像源 (`registry.npmmirror.com`)
   - 加速 npm 包下载

2. **GitHub Actions 优化**
   - 同时推送到 GitHub Container Registry (ghcr.io) 和阿里云容器镜像服务
   - 使用 Docker Buildx 提高构建效率
   - 启用 GitHub Actions 缓存加速构建
   - 支持多平台构建 (amd64, arm64)

---

## 阿里云容器镜像服务配置

### 第一步：注册阿里云账号

1. 访问 [阿里云官网](https://www.aliyun.com/)
2. 注册并登录账号
3. 完成实名认证（必须）

### 第二步：开通容器镜像服务

1. 访问 [容器镜像服务控制台](https://cr.console.aliyun.com/)
2. 选择 **个人版**（免费，适合个人项目）
3. 设置 Registry 登录密码（记住这个密码，后面要用）

### 第三步：创建命名空间

1. 在左侧菜单选择 **默认实例** → **命名空间**
2. 点击 **创建命名空间**
3. 填写信息：
   - **命名空间名称**：例如 `my-projects` 或 `your-username`
   - **是否公开**：选择 **公开** 或 **私有**（建议私有）
4. 点击 **确定**

### 第四步：创建镜像仓库（可选）

系统会自动创建，也可以手动创建：

1. 在左侧菜单选择 **默认实例** → **镜像仓库**
2. 点击 **创建镜像仓库**
3. 填写信息：
   - **命名空间**：选择刚才创建的命名空间
   - **仓库名称**：`ai-travel-planner`
   - **摘要**：AI 旅行规划应用
   - **仓库类型**：公开或私有
   - **代码源**：本地仓库
4. 点击 **下一步** → **创建镜像仓库**

### 第五步：获取访问凭证

需要获取以下信息：

1. **Registry 地址**：
   - 华东1（杭州）：`registry.cn-hangzhou.aliyuncs.com`
   - 华北2（北京）：`registry.cn-beijing.aliyuncs.com`
   - 华南1（深圳）：`registry.cn-shenzhen.aliyuncs.com`
   - 选择离你最近的区域

2. **用户名**：
   - 在控制台右上角点击头像 → **访问凭证**
   - 查看 **用户名**（通常是你的阿里云账号 ID）

3. **密码**：
   - 就是第二步设置的 Registry 登录密码
   - 如果忘记了，可以在 **访问凭证** 页面重置

---

## GitHub Secrets 配置

### 添加密钥到 GitHub 仓库

1. 打开你的 GitHub 仓库
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**
4. 添加以下三个密钥：

#### Secret 1: ALIYUN_USERNAME
```
Name: ALIYUN_USERNAME
Secret: 你的阿里云用户名（在访问凭证页面查看）
```

#### Secret 2: ALIYUN_PASSWORD
```
Name: ALIYUN_PASSWORD
Secret: 你的 Registry 登录密码
```

#### Secret 3: ALIYUN_NAMESPACE
```
Name: ALIYUN_NAMESPACE
Secret: 你创建的命名空间名称（例如：my-projects）
```

### 示例截图说明

添加完成后，你应该看到以下三个 secrets：
- ✅ `ALIYUN_USERNAME`
- ✅ `ALIYUN_PASSWORD`
- ✅ `ALIYUN_NAMESPACE`

---

## 验证部署

### 触发 GitHub Actions

1. **方法一：推送代码**
   ```bash
   git add .
   git commit -m "feat: 配置阿里云镜像服务"
   git push origin main
   ```

2. **方法二：创建标签**
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

### 查看构建状态

1. 打开 GitHub 仓库
2. 点击 **Actions** 标签
3. 查看最新的 workflow 运行状态
4. 点击进入查看详细日志

### 构建成功标志

✅ 看到以下日志表示成功：
```
pushing manifest for ghcr.io/your-username/ai-travel-planner:latest
pushing manifest for registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-planner:latest
```

---

## 使用镜像

### 从 GitHub 拉取镜像

```bash
# 登录 GitHub Container Registry
docker login ghcr.io -u YOUR_GITHUB_USERNAME

# 拉取镜像
docker pull ghcr.io/YOUR_GITHUB_USERNAME/ai-travel-planner:latest

# 运行容器
docker run -d -p 3000:80 ghcr.io/YOUR_GITHUB_USERNAME/ai-travel-planner:latest
```

### 从阿里云拉取镜像（推荐，国内速度快）

```bash
# 如果是公开仓库，不需要登录
# 如果是私有仓库，需要先登录
docker login registry.cn-hangzhou.aliyuncs.com -u YOUR_ALIYUN_USERNAME

# 拉取镜像
docker pull registry.cn-hangzhou.aliyuncs.com/YOUR_NAMESPACE/ai-travel-planner:latest

# 运行容器
docker run -d -p 3000:80 registry.cn-hangzhou.aliyuncs.com/YOUR_NAMESPACE/ai-travel-planner:latest
```

### 使用 Docker Compose

更新 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  ai-travel-planner:
    # 使用阿里云镜像（国内速度快）
    image: registry.cn-hangzhou.aliyuncs.com/YOUR_NAMESPACE/ai-travel-planner:latest
    # 或使用 GitHub 镜像
    # image: ghcr.io/YOUR_GITHUB_USERNAME/ai-travel-planner:latest
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    container_name: ai-travel-planner
    networks:
      - travel-network

networks:
  travel-network:
    driver: bridge
```

启动服务：
```bash
docker-compose up -d
```

---

## 📝 常见问题

### Q1: 阿里云镜像仓库地址选择哪个？
**A:** 选择离你服务器最近的区域：
- 国内推荐：杭州、北京、深圳
- 海外可以继续使用 GitHub Container Registry

### Q2: 命名空间可以包含什么字符？
**A:** 只能包含小写字母、数字和短横线(-)，2-30个字符

### Q3: 构建失败怎么办？
**A:** 检查以下几点：
1. GitHub Secrets 是否正确配置
2. 阿里云 Registry 密码是否正确
3. 命名空间名称是否匹配
4. 查看 Actions 日志获取详细错误信息

### Q4: 如何查看已推送的镜像？
**A:** 
- **GitHub**: 仓库页面右侧 → Packages
- **阿里云**: 容器镜像服务控制台 → 镜像仓库 → 选择仓库 → 镜像版本

### Q5: 免费额度够用吗？
**A:** 
- **GitHub**: 公开仓库免费，私有仓库有存储限制
- **阿里云个人版**: 
  - 3个命名空间
  - 300个仓库
  - 无限制的镜像拉取
  - 对个人项目完全够用

---

## 🎉 完成

现在你的项目已经配置完成：

✅ Dockerfile 使用阿里云 npm 源加速
✅ GitHub Actions 自动构建并推送到两个镜像仓库
✅ 支持多平台镜像 (amd64, arm64)
✅ 启用构建缓存提高速度
✅ 国内可以快速拉取阿里云镜像

每次推送到 main 分支或创建 tag，都会自动触发构建和推送！

---

## 📚 相关链接

- [阿里云容器镜像服务文档](https://help.aliyun.com/product/60716.html)
- [GitHub Container Registry 文档](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
- [Docker Buildx 文档](https://docs.docker.com/buildx/working-with-buildx/)

---

## 💡 建议

1. **定期清理旧镜像**：节省存储空间
2. **使用标签管理版本**：便于回滚
3. **设置镜像仓库为私有**：保护代码安全
4. **配置镜像扫描**：检查安全漏洞

如有问题，请查看 GitHub Actions 日志或阿里云控制台获取详细信息。
