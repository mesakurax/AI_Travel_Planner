# 🚀 阿里云容器镜像服务配置指南（上海区域）

## 📋 配置概览

本项目使用阿里云容器镜像服务（上海区域）来加速 Docker 镜像的构建和分发。

**区域信息：**
- **Registry 地址**：`crpi-q6jikadfo82vknso.cn-shanghai.personal.cr.aliyuncs.com`
- **用户名**：`aliyun4121920273`
- **区域名称**：华东2（上海）- 个人实例
- **优势**：适合华东地区服务器，访问速度快

---

## ⚡ 快速配置步骤

### 第一步：阿里云配置

1. **访问阿里云容器镜像服务控制台**
   - 地址：<https://cr.console.aliyun.com/>
   - 选择区域：**华东2（上海）**

2. **开通服务并设置密码**
   - 首次使用需要开通个人版服务（免费）
   - 设置 Registry 登录密码（务必记住）

3. **创建命名空间**
   - 左侧菜单：默认实例 → 命名空间
   - 点击"创建命名空间"
   - 命名空间名称：例如 `my-projects`（只能包含小写字母、数字、短横线）
   - 设置为私有或公开（建议私有）

4. **获取访问凭证**
   - 点击右上角头像 → "访问凭证"
   - 记录：
     - **用户名**：通常是你的阿里云账号 ID
     - **密码**：刚才设置的 Registry 登录密码

### 第二步：GitHub Secrets 配置

在 GitHub 仓库中添加以下 3 个 Secrets：

**路径**：仓库 → Settings → Secrets and variables → Actions → New repository secret

| Secret 名称 | 值 | 说明 |
|------------|---|------|
| `ALIYUN_USERNAME` | 你的阿里云用户名 | 在"访问凭证"页面查看 |
| `ALIYUN_PASSWORD` | Registry 登录密码 | 第一步设置的密码 |
| `ALIYUN_NAMESPACE` | 命名空间名称 | 例如：`my-projects` |

### 第三步：推送代码触发构建

```bash
git add .
git commit -m "feat: 配置阿里云上海区域镜像服务"
git push origin main
```

---

## 🎯 使用镜像

### 从阿里云拉取镜像（国内推荐）

```bash
# 如果是私有仓库，需要先登录
docker login --username=aliyun4121920273 crpi-q6jikadfo82vknso.cn-shanghai.personal.cr.aliyuncs.com

# 拉取镜像
docker pull crpi-q6jikadfo82vknso.cn-shanghai.personal.cr.aliyuncs.com/<你的命名空间>/ai-travel-planner:latest

# 运行容器
docker run -d -p 3000:80 crpi-q6jikadfo82vknso.cn-shanghai.personal.cr.aliyuncs.com/<你的命名空间>/ai-travel-planner:latest
```

### 从 GitHub 拉取镜像

```bash
# 拉取镜像
docker pull ghcr.io/<你的GitHub用户名>/ai-travel-planner:latest

# 运行容器
docker run -d -p 3000:80 ghcr.io/<你的GitHub用户名>/ai-travel-planner:latest
```

### 使用 Docker Compose

创建或更新 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  ai-travel-planner:
    # 使用阿里云上海区域镜像（国内速度快）
    image: registry.cn-shanghai.aliyuncs.com/<你的命名空间>/ai-travel-planner:latest
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    container_name: ai-travel-planner
```

启动服务：

```bash
docker-compose up -d
```

---

## 🔍 验证部署

### 查看构建状态

1. 推送代码后，访问 GitHub Actions 页面
2. 查看最新的 workflow 运行状态
3. 成功标志：看到以下日志

```text
✅ pushing manifest for ghcr.io/你的用户名/ai-travel-planner:latest
✅ pushing manifest for registry.cn-shanghai.aliyuncs.com/你的命名空间/ai-travel-planner:latest
```

### 查看镜像仓库

**阿里云：**
- 控制台：<https://cr.console.aliyun.com/>
- 左侧菜单：默认实例 → 镜像仓库
- 找到 `ai-travel-planner` 仓库查看镜像版本

**GitHub：**
- 仓库页面右侧 → Packages
- 查看 `ai-travel-planner` 包

---

## 📝 配置文件说明

### Dockerfile 优化

```dockerfile
# 使用阿里云 npm 镜像源加速依赖安装
RUN npm config set registry https://registry.npmmirror.com
```

这样可以避免 npm 安装时的 503 错误。

### GitHub Actions Workflow

关键配置点：

```yaml
env:
  # 阿里云容器镜像服务（上海区域）
  ALIYUN_REGISTRY: registry.cn-shanghai.aliyuncs.com
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  ALIYUN_IMAGE_NAME: ai-travel-planner
```

工作流程会：
1. ✅ 使用阿里云 npm 源加速构建
2. ✅ 构建多平台镜像（amd64, arm64）
3. ✅ 同时推送到 GitHub 和阿里云上海区域
4. ✅ 使用构建缓存加速后续构建

---

## 🆘 常见问题

### Q1: 为什么选择上海区域？

**A:** 
- 如果你的服务器在华东地区，上海区域访问速度最快
- 如果在其他区域，可以选择对应的区域：
  - 华北：`registry.cn-beijing.aliyuncs.com`
  - 华南：`registry.cn-shenzhen.aliyuncs.com`
  - 华东：`registry.cn-hangzhou.aliyuncs.com` 或 `registry.cn-shanghai.aliyuncs.com`

### Q2: 构建失败提示 "denied: requested access to the resource is denied"

**A:** 
- 检查 GitHub Secrets 中的 `ALIYUN_USERNAME` 和 `ALIYUN_PASSWORD` 是否正确
- 确认密码是 Registry 登录密码，不是阿里云账号密码
- 可以在阿里云控制台"访问凭证"页面重置密码

### Q3: 命名空间不存在错误

**A:**
- 确保 `ALIYUN_NAMESPACE` 的值与阿里云创建的命名空间名称完全一致
- 命名空间名称区分大小写
- 登录阿里云控制台确认命名空间是否已创建

### Q4: 能否同时使用多个区域？

**A:**
- 可以，但需要修改 workflow 配置
- 建议只使用一个主要区域，避免复杂化
- 上海区域已经能覆盖大部分国内需求

### Q5: 如何切换到其他区域？

**A:**
如果需要切换到其他区域，只需修改 `.github/workflows/docker-build.yml` 中的这一行：

```yaml
ALIYUN_REGISTRY: registry.cn-shanghai.aliyuncs.com
```

改为其他区域地址即可。

---

## 🎉 配置完成检查清单

完成以下步骤后，你的配置就完全正确了：

- [ ] 阿里云容器镜像服务已开通（上海区域）
- [ ] 设置了 Registry 登录密码
- [ ] 创建了命名空间
- [ ] 记录了用户名和密码
- [ ] GitHub 添加了 3 个 Secrets（ALIYUN_USERNAME, ALIYUN_PASSWORD, ALIYUN_NAMESPACE）
- [ ] 推送代码到 GitHub
- [ ] GitHub Actions 构建成功
- [ ] 在阿里云控制台看到镜像
- [ ] 能成功拉取和运行镜像

---

## 📚 相关资源

- [阿里云容器镜像服务文档](https://help.aliyun.com/product/60716.html)
- [GitHub Container Registry 文档](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
- [Docker Buildx 文档](https://docs.docker.com/buildx/working-with-buildx/)
- [阿里云各区域 Registry 地址](https://help.aliyun.com/document_detail/60750.html)

---

## 💡 优势总结

✅ **解决 503 问题** - 使用阿里云 npm 镜像源  
✅ **加速国内访问** - 上海区域在华东地区速度最快  
✅ **双仓库推送** - 同时推送到 GitHub 和阿里云  
✅ **自动化部署** - 每次推送自动构建和发布  
✅ **多平台支持** - 支持 amd64 和 arm64 架构  
✅ **构建缓存** - 加速后续构建速度  

祝使用愉快！🎊
